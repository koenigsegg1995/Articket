<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.maddog.articket.activity.dao.ActivityDao">

<!-- sql -->
    <sql id="columnsForInsert">
        partner_id,
        venue_id,
        venue_rental_id,
        activity_name,
        activity_content,
        activity_post_time,
        activity_tag,
        activity_status,
        ticket_set_status,
        sell_time
    </sql>

    <sql id="columnsForView">
        a.activity_id,
        a.activity_name,
        a.activity_post_time,
        a.activity_content,
        a.activityTag,
        v.venue_name,
        p.partner_name
    </sql>
<!-- sql -->

<!-- resultMap-->
    <resultMap id="forViewResultMap" type="com.maddog.articket.activity.dto.ActivityForView">
        <id column="activity_id" property="activityId" />
        <result column="activity_name" property="activityName" />
        <result column="activity_post_time" property="activityPostTime" />
        <result column="activity_content" property="activityContent" />
        <result column="activity_tag" property="activityTag" />
        <result column="venue_name" property="venueName" />
        <result column="partner_name" property="partnerName" />
    </resultMap>
<!-- resultMap-->

<!-- method-->
    <!-- 新增活動-->
    <insert id="insert"
            parameterType="com.maddog.articket.activity.entity.Activity">
        INSERT INTO activity
        (
            <include refid="columnsForInsert" />
        )
        VALUES
        (
            #{partnerId},
            #{venueId},
            #{venueRentalId},
            #{activityName},
            #{activityContent},
            #{activityPostTime},
            #{activityTag},
            #{activityStatus},
            #{ticketSetStatus},
            #{sellTime}
        )
    </insert>

    <!-- 更新活動-->
    <update id="update"
            parameterType="com.maddog.articket.activity.entity.Activity">
        UPDATE
            activity
        <set>
            <if test=" partnerId != null and partnerId != '' ">
                partner_id = #{partnerId},
            </if>


            venue_id = #{venueId},
            venue_rental_id = #{venueRentalId},
            activity_name = #{activityName},
            activity_content = #{activityContent},
            activity_post_time = #{activityPostTime},
            activity_tag = #{activityTag},
            activity_status = #{activityStatus},
            ticket_set_status = #{ticketSetStatus},
            sell_time = #{sellTime}
        </set>
        WHERE
            activity_id = #{activityId}
    </update>

    <!-- 刪除活動-->
    <delete id="deleteById"
            parameterType="java.lang.Integer">
        DELETE FROM
            activity
        WHERE
            #{activityId}
    </delete>

    <!-- 依 ID 查詢活動 DO -->
    <select id="findById"
            parameterType="java.lang.Integer"
            resultType="com.maddog.articket.activity.entity.Activity">
        SELECT
            *
        FROM
            activity
        WHERE
            activity_id = #{activityId}
    </select>

    <!-- 依 ID 查詢活動 VO -->
    <select id="findByIdForView"
            parameterType="java.lang.Integer"
            resultMap="forViewResultMap">
        SELECT
            <include refid="columnsForView" />
        FROM
            activity a
        LEFT JOIN
            venue v
            ON
            a.venue_id = v.venue_id
        LEFT JOIN
            partner_member p
            ON
            a.partner_id = p.partner_id
        WHERE
            activity_id = #{activityId}
    </select>

    <!-- 查詢所有活動 DO -->
    <select id="findAll"
            resultType="com.maddog.articket.activity.entity.Activity">
        SELECT
            *
        FROM
            activity
        ORDER BY
            activity_id
    </select>

    <!-- 依條件查詢活動 VO 清單 -->
    <select id="findByConditionForView"
            parameterType="com.maddog.articket.activity.dto.ActivityQueryCondition"
            resultType="com.maddog.articket.activity.dto.ActivityForView">
        SELECT
            <include refid="columnsForView" />
        FROM
            activity
        LEFT JOIN
            venue v
            ON
            a.venue_id = v.venue_id
        LEFT JOIN
            partner_member p
            ON
            a.partner_id = p.partner_id
        <where>
            <if test=" venueIdList != null and venueIdList.size() > 0 ">
                AND venue_id IN
                    <foreach collection="venueIdList"
                             item="venueId"
                             open="("
                             close=")"
                             separator=",">
                        #{venueId)
                    </foreach>
            </if>

            <if test=" activityTagList != null and activityTagList.size() > 0 ">
                AND activityTag IN
                    <foreach collection="activityTagList"
                             item="activityTag"
                             open="("
                             close=")"
                             separator=",">
                        #{activityTag}
                    </foreach>
            </if>
        </where>
        ORDER BY
            activity_id
    </select>

    <!-- 確認活動是否由該廠商所有-->
    <select id="isActivityOwnedByPartner"
            resultType="java.lang.Boolean">
        SELECT EXIST(
            SELECT
                1
            FROM
                activity a
            WHERE
                activity_id = #{activityId}
                AND
                partner_id = #{partnerId}
        )
    </select>
<!-- 依活動 ID 查詢圖片 ID 清單-->
    <select id="findActivityPictureIdByActivityId"
            parameterType="java.lang.Integer"
            resultType="java.lang.Integer">
        SELECT
            activity_picture_id
        FROM
            activity_picture
        WHERE
            activity_id = #{activityId}
        ORDER BY
            activity_picture_id
    </select>

    <select id="findActivityTimeSlotByActivityId"
            parameterType="java.lang.Integer"
            resultType="com.maddog.articket.activitytimeslot.entity.ActivityTimeSlot">
        SELECT
            *
        FROM
            activity_time_slot
        WHERE
            activity_id = #{activityId}
        ORDER BY
            activity_time_slot_date, activity_time_slot
    </select>
    <!-- method-->

</mapper>